SELECT
	E.NAME_FULL_FORMATTED
	, E.PERSON_ID
	, ADMIT = NULLVAL(E.ARRIVE_DT_TM,E.REG_DT_TM) "@SHORTDATETIME"
	, DEPART = NULLVAL(E.DEPART_DT_TM,E.DISCH_DT_TM) "@SHORTDATETIME"
	, ENCNTR_DATES = CONCAT(
  		IF (NULLIND(E.ARRIVE_DT_TM)=1) FORMAT(E.REG_DT_TM,"DD/MM/YY HH:MM")
  		ELSE FORMAT(E.ARRIVE_DT_TM,"DD/MM/YY HH:MM") ENDIF
  		," - ",
  		IF(NULLIND(E.DEPART_DT_TM)=1) FORMAT(E.DISCH_DT_TM,"DD/MM/YY HH:MM")
  		ELSE FORMAT(E.DEPART_DT_TM,"DD/MM/YY HH:MM") ENDIF
  		)

FROM
	ENCOUNTER   E

WHERE  
	E.MED_SERVICE_CD = 313015 ; 'ONCOLOGY' MED SERVICE PATIENTS
	AND (;DEPARTED DATE IS IN THE FUTURE OR NEVER AT ALL
		E.DEPART_DT_TM > CNVTDATETIME(CURDATE, CURTIME3)
		OR
		E.DISCH_DT_TM > CNVTDATETIME(CURDATE, CURTIME3)
		OR 
        (E.DEPART_DT_TM IS NULL AND E.DISCH_DT_TM IS NULL)
    )
	AND (; RECORDED DATE IS TURNED UP IN THE PAST
        E.ARRIVE_DT_TM < CNVTDATETIME(CURDATE, CURTIME3)
        OR 
        E.REG_DT_TM < CNVTDATETIME(CURDATE, CURTIME3)
    )

WITH MAXROW = 5000, NOCOUNTER, SEPARATOR=" ", FORMAT